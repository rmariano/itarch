<!DOCTYPE html>
<html lang="en"  class="theme--light" >

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://rmariano.eu/images/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://rmariano.eu/images/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://rmariano.eu/images/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://rmariano.eu/images/apple-touch-icon-57x57.png" />
  <link rel="short icon" href="https://rmariano.eu/images/favicon.png" type="image/x-icon" />
  <link rel="stylesheet" href="https://rmariano.eu/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
  <title>IT Arch â€¢ Subtleties of Python</title>
  
  
  
</head>

<body>
  <div id="sidebar" class="animated fadeInDown">
    <div class="logo-title">
      <div class="title">
        <img src=https://rmariano.eu/images/logo@2x.png style="width:127px;" alt="logo" />
        <h3><a href="https://rmariano.eu/">IT Arch</a></h3>
        <div class="description">
          <p>A blog about software engineering.</p>
        </div>
      </div>
    </div>
    <ul class="social-links"><li><a href="https://github.com/rmariano" aria-label="Go to Github profile page"><i class="fab fa-github"></i></a></li><li><a href="https://gitlab.com/rmariano" aria-label="Go to Gitlab profile page"><i class="fab fa-gitlab"></i></a></li><li><a href="https://twitter.com/rmarianoa" aria-label="Go to Twitter profile page"><i class="fab fa-twitter"></i></a></li>
      
    </ul>
  </div>
  <div id="main">
    <div class="page-top animated fadeInDown">
      <div class="nav">
        
        
        
        
        <li><a  href="https://rmariano.eu/">Home</a></li>
        <li><a  href="https://rmariano.eu/about/">About</a></li><li><a  href="https://rmariano.eu/tags">Tags</a></li><li><a 
            href="https://rmariano.eu/archive/">Archive</a></li></div>
      <div class="information">
        <div class="back_btn">
          <a onclick="window.history.go(-1)" ><i
              class="fas fa-chevron-left"></i></a>
        </div>
        
        
        
        <div class="avatar"><img src="https://rmariano.eu/images/avatar.jpg"></div>
      </div>
    </div>
    <div class="autopagerize_page_element">
      <div class="content">
        
<article class="post animated fadeInDown">
  <h1><a href="https:&#x2F;&#x2F;rmariano.eu&#x2F;subtleties-of-python&#x2F;">Subtleties of Python</a></h1>
  
  <div class="post-content"><p>In our profession, attention to detail is of utmost importance. Any good
software engineer understands that details matter a lot, as they make
the difference between a working unit or a disaster<sup class="footnote-reference"><a href="#1">1</a></sup>.</p>
<p>This is why clean code is not just about formatting or arranging the
code. It's neither a foible. It is instead, paying attention exactly to
those details that will make a big difference in production.</p>
<p>Let's see some examples of this in Python.</p>
<p>Disclaimer: The following cases being presented are just examples. They
are not meant to be interpreted as patterns, in the sense of &quot;every
time you find X, apply Y&quot;.</p>
<p>Below there are two short cases of problematic code I have found in
whilst working on past code bases.</p>
<h1 id="mutable-objects-and-attributes">Mutable Objects and Attributes</h1>
<p>This is one of the main reasons why I like functional programming:
immutability.</p>
<p>In functional software, we wouldn't be talking about mutation, because
such a thing is simply not allowed. But I digress. The point is that in
most of the software defined with objects, they mutate, they change
their internal state or representation. It's true that we could have
immutable objects, but that's usually not the case.</p>
<p>Consider the following code (spoiler: there is something really wrong
with it).</p>
<script src="https://gist.github.com/rmariano/b6587a30203674da35d2239e50a969db.js?file=subtleties0.py"></script>
<p>When trying to use dictionaries to pass keyword arguments, it might be
tempting to mutate them in order to adapt it to the signature of the
function we want to call. But before mutating an object, we should think
on it's scope and the consequences this mutation will bring.</p>
<p>In this case, the dictionary that the method mutates belongs to the
class. Changing it, will change the class. After it has been mutated,
the default values will remain from the last time it was updated.
Moreover, since this dictionary belongs to the class, all instances
(including new ones), will carry on with this:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>&gt;&gt;&gt; q = </span><span style="color:#bf616a;">Query</span><span>()
</span><span>&gt;&gt;&gt; q.</span><span style="color:#bf616a;">run_query</span><span>(&quot;</span><span style="color:#a3be8c;">select 1</span><span>&quot;)
</span><span>running select </span><span style="color:#d08770;">1 </span><span>[</span><span style="color:#d08770;">100</span><span>, </span><span style="color:#d08770;">0</span><span>]
</span><span>
</span><span>&gt;&gt;&gt; q.</span><span style="color:#bf616a;">run_query</span><span>(&quot;</span><span style="color:#a3be8c;">select 1</span><span>&quot;, </span><span style="color:#bf616a;">limit</span><span>=</span><span style="color:#d08770;">50</span><span>)
</span><span>running select </span><span style="color:#d08770;">1 </span><span>[</span><span style="color:#d08770;">50</span><span>, </span><span style="color:#d08770;">0</span><span>]
</span><span>
</span><span>&gt;&gt;&gt; q.</span><span style="color:#bf616a;">run_query</span><span>(&quot;</span><span style="color:#a3be8c;">select 1</span><span>&quot;)
</span><span>running select </span><span style="color:#d08770;">1 </span><span>[</span><span style="color:#d08770;">50</span><span>, </span><span style="color:#d08770;">0</span><span>]
</span><span>
</span><span>&gt;&gt;&gt; q.</span><span style="color:#bf616a;">PARAMETERS
</span><span>{&#39;</span><span style="color:#a3be8c;">limit</span><span>&#39;: </span><span style="color:#d08770;">50</span><span>, &#39;</span><span style="color:#a3be8c;">offset</span><span>&#39;: </span><span style="color:#d08770;">0</span><span>}
</span><span>
</span><span>&gt;&gt;&gt; new_query = </span><span style="color:#bf616a;">Query</span><span>()
</span><span>&gt;&gt;&gt; new_query.</span><span style="color:#bf616a;">PARAMETERS
</span><span>{&#39;</span><span style="color:#a3be8c;">limit</span><span>&#39;: </span><span style="color:#d08770;">50</span><span>, &#39;</span><span style="color:#a3be8c;">offset</span><span>&#39;: </span><span style="color:#d08770;">0</span><span>}
</span></code></pre>
<p>As we can observe, this is not what we want, and it's extremely
fragile.</p>
<p>Here are some general recommendations:</p>
<ol>
<li>Don't change mutable objects passed by parameter to functions.
Create new copies of the objects whenever possible, and return them
accordingly.</li>
<li>Don't mutate class attributes.</li>
<li>Try not to set mutable objects as class attributes.</li>
</ol>
<p>Needless to say, there are exceptions to these rules, after all
<em>pragmatism beats purity</em>. Here are some obvious exceptions to these
rules<sup class="footnote-reference"><a href="#2">2</a></sup>: :</p>
<ul>
<li>For item 1, we always have to consider the trade-off memory/speed.
If the object it's too big (perhaps a large dictionary), running
<code>copy.deepcopy()</code> on it will be slow, and it will take a lot of
memory, so it's probably faster to just modify it in place.</li>
<li>The obvious exception for rule [2] is when using descriptors, but
because it's likely an scenario on which we are counting on that
side effect. Other than that, there shouldn't be any reason to go
on such a dangerous path.</li>
<li>Rule [3] shouldn't be a problem if the attributes are read-only,
and we're sure they are never going to be mutated. In that case,
setting dictionaries and lists as class attributes, might be fine,
but I'm only worried about the fact that even though you can be
sure that right now there is no method mutating them, you can't
assure nobody will break that rule in the future.</li>
</ul>
<h1 id="iterators">Iterators</h1>
<p>The iterator protocol in Python is a great feature. It allows us to
treat an entire set of objects by their behaviour regardless of their
internal representation.</p>
<p>For instance we can write a code like:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">for </span><span>i </span><span style="color:#b48ead;">in </span><span>myiterable: </span><span style="color:#d08770;">...
</span></code></pre>
<p>And we don't know exactly what <code>myiterable</code> is. It might be a list, a
tuple, a dictionary, a string, and it will still work.</p>
<p>We can also rely on all methods that use this protocol,</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>mylist.</span><span style="color:#bf616a;">extend</span><span>(myiterable)
</span></code></pre>
<p>Of course <code>mylist</code> has to be a list, but again <code>myiterable</code> can be
anything that can be iterated over.</p>
<p>Unfortunately, this amazing feature it's also the cause of some subtle
headaches.</p>
<p>A long time ago, I remember hearing a complaint from a co-worker saying
that a part of the code was particularly slow. The code in question was
a function that was supposed to process and then move files to a given
target directory. You can imagine something like this:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">process_files</span><span>(</span><span style="color:#bf616a;">files_to_process</span><span>, </span><span style="color:#bf616a;">target_directory</span><span>):
</span><span>    </span><span style="color:#b48ead;">for </span><span>file_ </span><span style="color:#b48ead;">in </span><span>files_to_process:
</span><span>        </span><span style="color:#65737e;"># ...
</span><span>        shutil.</span><span style="color:#bf616a;">copy2</span><span>(file_, target_directory)
</span></code></pre>
<p>Now what happens? Like in the introduction, we are using the iterator
protocol, so we rely on the fact that we don't exactly know what
<code>files_to_process</code> is exactly (a tuple, a list, etc.)</p>
<p>There is a subtle issue. Strings are also <code>iterable</code>. If you pass a
single file, let's say <code>/home/ubuntu/foo</code>, each character will be
iterated over, starting with <code>/</code> (the root directory), following with
<code>h</code>, etc. That's why the programs was slow. It was copying the entire
file system!</p>
<p>The solution is to use a better interface, that disallow these errors
entirely:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">process_files</span><span>(*</span><span style="color:#bf616a;">files_to_process</span><span>, </span><span style="color:#bf616a;">target_directory</span><span>):
</span><span>    </span><span style="color:#b48ead;">for </span><span>file_ </span><span style="color:#b48ead;">in </span><span>files_to_process:
</span><span>        </span><span style="color:#65737e;"># ...
</span><span>        shutil.</span><span style="color:#bf616a;">copy2</span><span>(file_, target_directory)
</span></code></pre>
<p>In this example the signature of the function exposes a much nicer
interface, in the sense that it can allow one or multiple files as
arguments, without the issue of the previous example. This change also
makes <code>target_directory</code> to be keyword-only, which is more explicit as
well.</p>
<h1 id="closing-words">Closing words</h1>
<p>I hope you enjoyed the content, and that you got an idea of how critical
some details can be.</p>
<p>The real value of clean code is to avoid disasters. Topics like these
ones (and more), are covered in <a href="https://www.amazon.com/Clean-Code-Python-Refactor-legacy/dp/1788835832">my latest
title</a>,
should the reader be interested.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>I'm not exaggerating when I say disaster. There are many famous
examples of crashes in software as a result of edge cases, or errors
that can be narrowed down to a single line of code.</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>The list is by no means exhaustive.</p>
</div>
</div>
  <div class="post-footer">
    <div class="meta">
      <div class="info">
        
        <i class="far fa-sun"></i><span class="date">Thu Oct 18, 2018 23:03:39 +0200</span>
        
        
        <i class="fas fa-tags"></i>
        
        <a class="tag" href="https://rmariano.eu/tags/python">&nbsp;python</a>
        
        <a class="tag" href="https://rmariano.eu/tags/clean-code">&nbsp;clean-code</a>
        
        
      </div>
    </div>
  </div>
</article>
<div class="share">
  <div class="twitter">
    <a class="fab fa-twitter"
      href="http://twitter.com/share?text=Subtleties of Python&url=https:&#x2F;&#x2F;rmariano.eu&#x2F;subtleties-of-python&#x2F;&hashtags=python,clean-code"></a>
  </div>
</div>










      </div>
    </div>
  </div>
  
  <script>
    function showLanguages() {
      let currentDisplay = document.getElementById("languages").style.display;
      if (currentDisplay == 'none') {
        document.getElementById("languages").style.display = 'block';
      } else {
        document.getElementById("languages").style.display = 'none';
      }
    }
  </script>
</body>

</html>
