<!DOCTYPE html>
<html lang="en"  class="theme--light" >

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://rmariano.eu/images/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://rmariano.eu/images/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://rmariano.eu/images/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://rmariano.eu/images/apple-touch-icon-57x57.png" />
  <link rel="short icon" href="https://rmariano.eu/images/favicon.png" type="image/x-icon" />
  <link rel="stylesheet" href="https://rmariano.eu/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
  <title>IT Arch â€¢ strncpy and strncat for copying strings in C</title>
  
  
  
</head>

<body>
  <div id="sidebar" class="animated fadeInDown">
    <div class="logo-title">
      <div class="title">
        <img src=https://rmariano.eu/images/logo@2x.png style="width:127px;" alt="logo" />
        <h3><a href="https://rmariano.eu/">IT Arch</a></h3>
        <div class="description">
          <p>A blog about software engineering.</p>
        </div>
      </div>
    </div>
    <ul class="social-links"><li><a href="https://github.com/rmariano" aria-label="Go to Github profile page"><i class="fab fa-github"></i></a></li><li><a href="https://gitlab.com/rmariano" aria-label="Go to Gitlab profile page"><i class="fab fa-gitlab"></i></a></li><li><a href="https://twitter.com/rmarianoa" aria-label="Go to Twitter profile page"><i class="fab fa-twitter"></i></a></li>
      
    </ul>
  </div>
  <div id="main">
    <div class="page-top animated fadeInDown">
      <div class="nav">
        
        
        
        
        <li><a  href="https://rmariano.eu/">Home</a></li>
        <li><a  href="https://rmariano.eu/about/">About</a></li><li><a  href="https://rmariano.eu/tags">Tags</a></li><li><a 
            href="https://rmariano.eu/archive/">Archive</a></li></div>
      <div class="information">
        <div class="back_btn">
          <a onclick="window.history.go(-1)" ><i
              class="fas fa-chevron-left"></i></a>
        </div>
        
        
        
        <div class="avatar"><img src="https://rmariano.eu/images/avatar.jpg"></div>
      </div>
    </div>
    <div class="autopagerize_page_element">
      <div class="content">
        
<article class="post animated fadeInDown">
  <h1><a href="https:&#x2F;&#x2F;rmariano.eu&#x2F;copying-strings-in-c&#x2F;">strncpy and strncat for copying strings in C</a></h1>
  
  <div class="post-content"><p>Recently, I've read an interesting article<sup class="footnote-reference"><a href="#1">1</a></sup>, explaining why the
<code>strncpy</code> function in C is not safer than <code>strcpy</code>. The post was very
interesting, but what's more, it suggested an alternative idiom for
copying strings in C, that might probably be the way to go.</p>
<p>Later, in another article<sup class="footnote-reference"><a href="#2">2</a></sup> that compared some functionality in C,
Python and Go, one of the comments pointed out that very same idiom.
That grabbed my attention, so I decided to try it in an example.</p>
<p>The problem with <code>strncpy</code> seems to be the way it manages the source
string to be copied. Based on the sample code provided in the
documentation<sup class="footnote-reference"><a href="#3">3</a></sup> (that should be just a reference), the break condition
is up to <code>n</code> characters (the third parameter) or until the source string
is exhausted, whatever happens first. This should not be a problem,
unless <code>n &lt; strlen(source_string)</code>. That parameter would make <code>strncpy</code>
to finish before it can put a <code>\0</code> character at the end of the target
string, leaving an invalid array of characters<sup class="footnote-reference"><a href="#4">4</a></sup>.</p>
<p>This is an example.</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">stdio.h</span><span>&gt;  </span><span style="color:#65737e;">/* stdout, fprintf */
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">string.h</span><span>&gt;  </span><span style="color:#65737e;">/* strncpy, strlen */
</span><span>
</span><span style="color:#b48ead;">#define </span><span>TARGET </span><span style="color:#d08770;">10
</span><span>
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main</span><span>(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span>, </span><span style="color:#b48ead;">char</span><span>* </span><span style="color:#bf616a;">argv</span><span>[]) {
</span><span>
</span><span>    </span><span style="color:#b48ead;">char </span><span>*src = &quot;</span><span style="color:#a3be8c;">Castle</span><span>&quot;;  </span><span style="color:#65737e;">/* 6 chars long */
</span><span>    </span><span style="color:#b48ead;">char</span><span> dst[TARGET] = &quot;</span><span style="color:#a3be8c;">__________</span><span>&quot;;
</span><span>
</span><span>    dst[TARGET - </span><span style="color:#d08770;">1</span><span>] = &#39;</span><span style="color:#96b5b4;">\0</span><span>&#39;;
</span><span>
</span><span>    </span><span style="color:#96b5b4;">fprintf</span><span>(stdout, &quot;</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span>&quot;, dst);   </span><span style="color:#65737e;">/* must be: &#39;_________&#39; */
</span><span>    </span><span style="color:#65737e;">/* What happens if I pass a wrong length (lower than the actual
</span><span style="color:#65737e;">    * strlen) */
</span><span>    </span><span style="color:#96b5b4;">strncpy</span><span>(dst, src, </span><span style="color:#d08770;">3</span><span>);
</span><span>    </span><span style="color:#96b5b4;">fprintf</span><span>(stdout, &quot;</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span>&quot;, dst);   </span><span style="color:#65737e;">/* must be: &#39;Cas______&#39; */
</span><span>    </span><span style="color:#65737e;">/* If I copy the string correctly, by passing the right
</span><span style="color:#65737e;">    * length, then strcnpy behaves as expected */
</span><span>    </span><span style="color:#96b5b4;">strncpy</span><span>(dst, src, </span><span style="color:#96b5b4;">strlen</span><span>(src) + </span><span style="color:#d08770;">1</span><span>);
</span><span>    </span><span style="color:#96b5b4;">fprintf</span><span>(stdout, &quot;</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span>&quot;, dst);   </span><span style="color:#65737e;">/* must be: &#39;Castle&#39; */
</span><span>
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span>;
</span><span>}
</span></code></pre>
<p>On this example, the target array is represented by the variable <code>dst</code>,
and I used a fixed-length string, on purpose for the demonstration,
simulating what would actually happen. I null-terminated it so the
program can finish successfully, because otherwise the operations on it
would not end until the delimiter is reached, and we cannot know when
that will happen, considering what's in memory at that time. In
addition, the unpredictable behaviour will lead to errors, and probably
to memory corruption. The underscore, should be interpreted as slots:
regions or reserved memory that are there, but empty.</p>
<p>The proposed idiom uses <code>strncat</code> (see<sup class="footnote-reference"><a href="#5">5</a></sup>), tricking the function by
passing it an empty string as the first parameter, and then the actual
string we need to copy. This call will render the same result, but
without the previous side effect. Let's see an example:</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">stdio.h</span><span>&gt;  </span><span style="color:#65737e;">/* stdout, fprintf */
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">string.h</span><span>&gt;  </span><span style="color:#65737e;">/* strncat, strlen */
</span><span>
</span><span style="color:#b48ead;">#define </span><span>TARGET </span><span style="color:#d08770;">10
</span><span>
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main</span><span>(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span>, </span><span style="color:#b48ead;">char</span><span>* </span><span style="color:#bf616a;">argv</span><span>[]) {
</span><span>
</span><span>    </span><span style="color:#b48ead;">char </span><span>*src = &quot;</span><span style="color:#a3be8c;">Castle</span><span>&quot;;  </span><span style="color:#65737e;">/* 6 chars long */
</span><span>    </span><span style="color:#b48ead;">char</span><span> dst[TARGET] = &quot;</span><span style="color:#a3be8c;">__________</span><span>&quot;;
</span><span>    dst[TARGET - </span><span style="color:#d08770;">1</span><span>] = &#39;</span><span style="color:#96b5b4;">\0</span><span>&#39;;
</span><span>
</span><span>    </span><span style="color:#96b5b4;">fprintf</span><span>(stdout, &quot;</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span>&quot;, dst);   </span><span style="color:#65737e;">/* must be: &#39;_________&#39; */
</span><span>    </span><span style="color:#65737e;">/* Prepare destination string */
</span><span>    dst[</span><span style="color:#d08770;">0</span><span>] = &#39;</span><span style="color:#96b5b4;">\0</span><span>&#39;;
</span><span>    </span><span style="color:#65737e;">/* Copy with strncat */
</span><span>    </span><span style="color:#96b5b4;">strncat</span><span>(dst, src, </span><span style="color:#d08770;">3</span><span>);
</span><span>    </span><span style="color:#96b5b4;">fprintf</span><span>(stdout, &quot;</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span>&quot;, dst);   </span><span style="color:#65737e;">/* must be: &#39;Cas&#39; */
</span><span>    </span><span style="color:#65737e;">/* If I copy the string correctly, by passing the right
</span><span style="color:#65737e;">    * length, then strcnpy behaves as expected */
</span><span>    dst[</span><span style="color:#d08770;">0</span><span>] = &#39;</span><span style="color:#96b5b4;">\0</span><span>&#39;;
</span><span>    </span><span style="color:#96b5b4;">strncat</span><span>(dst, src, </span><span style="color:#96b5b4;">strlen</span><span>(src) + </span><span style="color:#d08770;">1</span><span>);
</span><span>    </span><span style="color:#96b5b4;">fprintf</span><span>(stdout, &quot;</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span>&quot;, dst);   </span><span style="color:#65737e;">/* must be: &#39;Castle&#39; */
</span><span>    </span><span style="color:#65737e;">/* If I try to overrun the buffer */
</span><span>    dst[</span><span style="color:#d08770;">0</span><span>] = &#39;</span><span style="color:#96b5b4;">\0</span><span>&#39;;
</span><span>    </span><span style="color:#96b5b4;">strncat</span><span>(dst, src, </span><span style="color:#96b5b4;">strlen</span><span>(src) + </span><span style="color:#d08770;">10</span><span>);
</span><span>    </span><span style="color:#96b5b4;">fprintf</span><span>(stdout, &quot;</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span>&quot;, dst);   </span><span style="color:#65737e;">/* must be: &#39;Castle&#39; */
</span><span>
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span>;
</span><span>}
</span></code></pre>
<p>Here we see, the error is no longer present, probably because of the
difference on the implementation (the snippet on the documentation<sup class="footnote-reference"><a href="#6">6</a></sup>
gives us a hint on what it does, so we can spot the change).</p>
<p>This might seem as a little issue, but it raised some concerns on the
Linux kernel development, at the point that a new function was
developed. The <code>strscpy</code> function is being included in the Kernel
development for <em>Linux 4.3-rc4</em><sup class="footnote-reference"><a href="#7">7</a></sup> because it <em>is</em> a better interface.
Some of the problems mentioned in the commit message, that inspired this
new version, are the ones described on the previous paragraphs.</p>
<p>This makes me wonder, if this should be the &quot;correct&quot; way for
performing this operation &quot;safely&quot; in C. In all cases, the error is
the same (not checking the boundaries, and trusting the input), and
should be avoided. What I mean by this, is that we cannot simply rely on
those functions being secure, the security must be in our code, so the
proper way to handle these situations is to <em>code defensively</em>: do not
trust user input, always check the boundaries, error codes, memory
allocation, status of the pointer (a <code>free</code> for every <code>malloc</code> but not
for a <code>NULL</code> pointer, etc.).</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p><a href="https://the-flat-trantor-society.blogspot.com.ar/2012/03/no-strncpy-is-not-safer-strcpy.html">https://the-flat-trantor-society.blogspot.com.ar/2012/03/no-strncpy-is-not-safer-strcpy.html</a>.</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://blog.surgut.co.uk/2015/08/go-enjoy-python3.html">https://blog.surgut.co.uk/2015/08/go-enjoy-python3.html</a>.</p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p><a href="https://linux.die.net/man/3/strncpy/">strncpy documentation</a>.</p>
</div>
<div class="footnote-definition" id="4"><sup class="footnote-definition-label">4</sup>
<p>An array of characters that is not null-terminated, is invalid.</p>
</div>
<div class="footnote-definition" id="5"><sup class="footnote-definition-label">5</sup>
<p><a href="https://linux.die.net/man/3/strncat/">strncat manual page</a>.</p>
</div>
<div class="footnote-definition" id="6"><sup class="footnote-definition-label">6</sup>
<p><a href="https://linux.die.net/man/3/strncat/">strncat manual page</a>.</p>
</div>
<div class="footnote-definition" id="7"><sup class="footnote-definition-label">7</sup>
<p><a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=30c44659f4a3e7e1f9f47e895591b4b40bf62671">https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=30c44659f4a3e7e1f9f47e895591b4b40bf62671</a>.</p>
</div>
</div>
  <div class="post-footer">
    <div class="meta">
      <div class="info">
        
        <i class="far fa-sun"></i><span class="date">Sun Sep 27, 2015 18:34:44 +0300</span>
        
        
        <i class="fas fa-tags"></i>
        
        <a class="tag" href="https://rmariano.eu/tags/linux">&nbsp;linux</a>
        
        <a class="tag" href="https://rmariano.eu/tags/C">&nbsp;C</a>
        
        <a class="tag" href="https://rmariano.eu/tags/security">&nbsp;security</a>
        
        <a class="tag" href="https://rmariano.eu/tags/best-practices">&nbsp;best-practices</a>
        
        
      </div>
    </div>
  </div>
</article>
<div class="share">
  <div class="twitter">
    <a class="fab fa-twitter"
      href="http://twitter.com/share?text=strncpy and strncat for copying strings in C&url=https:&#x2F;&#x2F;rmariano.eu&#x2F;copying-strings-in-c&#x2F;&hashtags=linux,C,security,best-practices"></a>
  </div>
</div>










      </div>
    </div>
  </div>
  
  <script>
    function showLanguages() {
      let currentDisplay = document.getElementById("languages").style.display;
      if (currentDisplay == 'none') {
        document.getElementById("languages").style.display = 'block';
      } else {
        document.getElementById("languages").style.display = 'none';
      }
    }
  </script>
</body>

</html>
